!function(e,t){"use strict";"undefined"!=typeof module&&module.exports?module.exports=t(require("angular")):"function"==typeof define&&define.amd?define(["angular"],t):t(e.angular)}(window,function(e){"use strict";e.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate",function(e,t,n,r,o,l,a){function i(t,l,a,i){function C(e,n){e&&("object"==typeof e?(t.searchStr=b(e),R({originalObject:e})):"string"==typeof e&&e.length>0?t.searchStr=e:console&&console.error&&console.error("Tried to set "+(n?"initial":"")+" value of angucomplete to",e,"which is an invalid value"),$(!0))}function y(e){pe=null,t.hideResults(e),document.body.removeEventListener("click",y)}function O(e){return e.which?e.which:e.keyCode}function R(e){"function"==typeof t.selectedObject?t.selectedObject(e):t.selectedObject=e,$(e?!0:!1)}function A(e){return function(n){return t[e]?t[e](n):n}}function D(e){R({originalObject:e}),t.clearSelected&&(t.searchStr=null),Z()}function b(e){return t.titleField.split(",").map(function(t){return M(e,t)}).join(" ")}function M(e,t){var n,r;if(t){n=t.split("."),r=e;for(var o=0;o<n.length;o++)r=r[n[o]]}else r=e;return r}function L(e,n){var o,l,a;return a=new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),e?(e.match&&e.replace||(e=e.toString()),l=e.match(a),o=l?e.replace(a,'<span class="'+t.matchClass+'">'+l[0]+"</span>"):e,r.trustAsHtml(o)):void 0}function $(e){t.notEmpty=e,se=t.searchStr,t.fieldRequired&&i&&t.inputName&&i[t.inputName].$setValidity(ie,e)}function T(e){var n=O(e);if(n!==d&&n!==c)if(n===u||n===g)e.preventDefault();else if(n===s)e.preventDefault(),!t.showDropdown&&t.searchStr&&t.searchStr.length>=le&&(B(),t.searching=!0,W(t.searchStr));else if(n===p)Z(),t.$apply(function(){oe.val(t.searchStr)});else{if(0===le&&!t.searchStr)return;t.searchStr&&""!==t.searchStr?t.searchStr.length>=le&&(B(),ae&&o.cancel(ae),t.searching=!0,ae=o(function(){W(t.searchStr)},t.pause)):t.showDropdown=!1,se&&se!==t.searchStr&&!t.clearSelected&&t.$apply(function(){R()})}}function F(e){!t.overrideSuggestions||t.selectedObject&&t.selectedObject.originalObject===t.searchStr||(e&&e.preventDefault(),o.cancel(ae),Y(),D(t.searchStr))}function N(e){var t=getComputedStyle(e);return e.offsetHeight+parseInt(t.marginTop,10)+parseInt(t.marginBottom,10)}function _(){return ue.getBoundingClientRect().top+parseInt(getComputedStyle(ue).maxHeight,10)}function E(){return l[0].querySelectorAll(".angucomplete-row")[t.currentIndex]}function U(){return E().getBoundingClientRect().top-(ue.getBoundingClientRect().top+parseInt(getComputedStyle(ue).paddingTop,10))}function G(e){ue.scrollTop=ue.scrollTop+e}function q(){var e=t.results[t.currentIndex];oe.val(t.matchClass?b(e.originalObject):e.title)}function P(e){var n=O(e),r=null,o=null;n===g&&t.results?(t.currentIndex>=0&&t.currentIndex<t.results.length?(e.preventDefault(),t.selectResult(t.results[t.currentIndex])):(F(e),Z()),t.$apply()):n===s&&t.results?(e.preventDefault(),t.currentIndex+1<t.results.length&&t.showDropdown&&(t.$apply(function(){t.currentIndex++,q()}),de&&(r=E(),_()<r.getBoundingClientRect().bottom&&G(N(r))))):n===u&&t.results?(e.preventDefault(),t.currentIndex>=1?(t.$apply(function(){t.currentIndex--,q()}),de&&(o=U(),0>o&&G(o-1))):0===t.currentIndex&&t.$apply(function(){t.currentIndex=-1,oe.val(t.searchStr)})):n===f?t.results&&t.results.length>0&&t.showDropdown?-1===t.currentIndex&&t.overrideSuggestions?F():(-1===t.currentIndex&&(t.currentIndex=0),t.selectResult(t.results[t.currentIndex]),t.$digest()):t.searchStr&&t.searchStr.length>0&&F():n===p&&e.preventDefault()}function H(e){return function(n,r,o,l){r||o||l||!n.data||(n=n.data),t.searching=!1,J(M(ee(n),t.remoteUrlDataField),e)}}function j(e,n,r,o){0!==n&&-1!==n&&(n||r||o||(n=e.status),t.remoteUrlErrorCallback?t.remoteUrlErrorCallback(e,n,r,o):console&&console.error&&console.error("http error"))}function Y(){ce&&ce.resolve()}function k(r){var o={},l=t.remoteUrl+encodeURIComponent(r);t.remoteUrlRequestFormatter&&(o={params:t.remoteUrlRequestFormatter(r)},l=t.remoteUrl),t.remoteUrlRequestWithCredentials&&(o.withCredentials=!0),Y(),ce=e.defer(),o.timeout=ce.promise,n.get(l,o).success(H(r)).error(j)}function X(n){Y(),ce=e.defer(),t.remoteApiHandler(n,ce.promise).then(H(n))["catch"](j)}function Z(){t.showDropdown=!1,t.results=[],ue&&(ue.scrollTop=0)}function B(){t.showDropdown=ne,t.currentIndex=t.focusFirst?0:-1,t.results=[]}function z(e){var n,r,o,l,a=t.searchFields.split(","),i=[];for("undefined"!=typeof t.parseInput()&&(e=t.parseInput()(e)),n=0;n<t.localData.length;n++){for(r=!1,o=0;o<a.length;o++)l=M(t.localData[n],a[o])||"",r=r||l.toString().toLowerCase().indexOf(e.toString().toLowerCase())>=0;r&&(i[i.length]=t.localData[n])}return i}function V(e,n,r){if(!r)return!1;for(var o in n)if(n[o].toLowerCase()===r.toLowerCase())return t.selectResult(e),!0;return!1}function W(e){!e||e.length<le||(t.localData?t.$apply(function(){var n;n="undefined"!=typeof t.localSearch()?t.localSearch()(e):z(e),t.searching=!1,J(n,e)}):t.remoteApiHandler?X(e):k(e))}function J(e,n){var r,o,l,a,i,s;if(e&&e.length>0)for(t.results=[],r=0;r<e.length;r++)t.titleField&&""!==t.titleField&&(a=i=b(e[r])),o="",t.descriptionField&&(o=s=M(e[r],t.descriptionField)),l="",t.imageField&&(l=M(e[r],t.imageField)),t.matchClass&&(i=L(a,n),s=L(o,n)),t.results[t.results.length]={title:i,description:s,image:l,originalObject:e[r]};else t.results=[];t.autoMatch&&1===t.results.length&&V(t.results[0],{title:a,desc:o||""},t.searchStr)?t.showDropdown=!1:0!==t.results.length||re?t.showDropdown=!0:t.showDropdown=!1}function K(){t.localData?J(t.localData,""):t.remoteApiHandler?X(""):k("")}var Q,ee,te,ne,re,oe=l.find("input"),le=h,ae=null,ie=w,se=null,ce=null,ue=l[0].querySelector(".angucomplete-dropdown"),de=!1,pe=null;l.on("mousedown",function(e){e.target.id?(pe=e.target.id,pe===t.id+"_dropdown"&&document.body.addEventListener("click",y)):pe=e.target.className}),t.currentIndex=t.focusFirst?0:null,t.searching=!1,te=t.$watch("initialValue",function(e){e&&(te(),C(e,!0))}),t.$watch("fieldRequired",function(e,n){e!==n&&(e?$(se&&-1!==t.currentIndex?!0:!1):i[t.inputName].$setValidity(ie,!0))}),t.$on("angucomplete-alt:clearInput",function(e,n){n&&n!==t.id||(t.searchStr=null,R(),$(!1),Z())}),t.$on("angucomplete-alt:changeInput",function(e,n,r){n&&n===t.id&&C(r)}),t.onFocusHandler=function(){t.focusIn&&t.focusIn(),0!==le||t.searchStr&&0!==t.searchStr.length||(t.currentIndex=t.focusFirst?0:t.currentIndex,t.showDropdown=!0,K())},t.hideResults=function(){pe&&(pe===t.id+"_dropdown"||pe.indexOf("angucomplete")>=0)?pe=null:(Q=o(function(){Z(),t.$apply(function(){t.searchStr&&t.searchStr.length>0&&oe.val(t.searchStr)})},v),Y(),t.focusOut&&t.focusOut(),t.overrideSuggestions&&t.searchStr&&t.searchStr.length>0&&-1===t.currentIndex&&F())},t.resetHideResults=function(){Q&&o.cancel(Q)},t.hoverRow=function(e){t.currentIndex=e},t.selectResult=function(e){t.matchClass&&(e.title=b(e.originalObject),e.description=M(e.originalObject,t.descriptionField)),t.clearSelected?t.searchStr=null:t.searchStr=e.title,R(e),Z()},t.inputChangeHandler=function(e){return e.length<le?(Y(),Z()):0===e.length&&0===le&&(t.searching=!1,K()),t.inputChanged&&(e=t.inputChanged(e)),e},t.fieldRequiredClass&&""!==t.fieldRequiredClass&&(ie=t.fieldRequiredClass),t.minlength&&""!==t.minlength&&(le=parseInt(t.minlength,10)),t.pause||(t.pause=S),t.clearSelected||(t.clearSelected=!1),t.overrideSuggestions||(t.overrideSuggestions=!1),t.fieldRequired&&i&&$(t.initialValue?!0:!1),t.inputType=a.type?a.type:"text",t.textSearching=a.textSearching?a.textSearching:x,t.textNoResults=a.textNoResults?a.textNoResults:I,ne="false"===t.textSearching?!1:!0,re="false"===t.textNoResults?!1:!0,t.maxlength=a.maxlength?a.maxlength:m,oe.on("keydown",P),oe.on("keyup",T),ee=A("remoteUrlResponseFormatter"),o(function(){var e=getComputedStyle(ue);de=e.maxHeight&&"auto"===e.overflowY})}var s=40,c=39,u=38,d=37,p=27,g=13,f=9,h=3,m=524288,S=500,v=200,w="autocomplete-required",x="Поиск...",I="Совпадений не найденно",C="/angucomplete-alt/index.html";return l.put(C,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name="{{inputName}}" tabindex="{{fieldTabindex}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",localSearch:"&",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",fieldTabindex:"@",inputName:"@",focusFirst:"@",parseInput:"&"},templateUrl:function(e,t){return t.templateUrl||C},compile:function(e){var t=a.startSymbol(),n=a.endSymbol();if("{{"!==t||"}}"!==n){var r=e.html().replace(/\{\{/g,t).replace(/\}\}/g,n);e.html(r)}return i}}}])});
var AzoftTest=angular.module("map_app",["ngRoute","angucomplete-alt"]).config(["$routeProvider",function(e){e.when("/search",{templateUrl:"views/search.html",controller:"SearchController"}).when("/create",{templateUrl:"views/create.html",controller:"CreateController"}).when("/map/:data*",{templateUrl:"views/map.html",controller:"MapController"}).when("/list",{templateUrl:"views/list.html",controller:"ListController"}),e.otherwise({redirectTo:"/search"})}]);
AzoftTest.factory("GMap",["$http",function(e){var t={LAT:55.00518863585595,LNG:82.9361343383789,ZOOM:12,DISPLAY_ZOOM:14,MAP_ID:"map_canvas"},n=function(e,n,r){var o=document.getElementById(t.MAP_ID);if(GBrowserIsCompatible()&&o){var l=new GMap2(o);return l.setCenter(new GLatLng(e||t.LAT,n||t.LNG),r||t.ZOOM),l.setUIToDefault(),{map:l,event:GEvent}}return alert("Не найден елемент "+t.MAP_ID),!1};return{setDISPLAY_ZOOM:function(e){t.DISPLAY_ZOOM=e||t.DISPLAY_ZOOM},setMAP_ID:function(e){t.MAP_ID=e||t.MAP_ID},setLAT:function(e){t.LAT=parseFloat(e||t.LAT)},setLNG:function(e){t.LNG=parseFloat(e||t.LNG)},setZOOM:function(e){t.ZOOM=parseInt(e||t.ZOOM)},addPoint:function(t){var r=n();t&&r&&r.event.addListener(r.map,"click",function(n,o){n||e.post("http://maps.google.com/maps/api/geocode/json?latlng="+o.lat()+","+o.lng()+"&sensor=false").success(function(e){if("OK"===e.status&&e.results.length){var n=e.results[0].formatted_address;r.map.openInfoWindow(o,n),t.address=n,t.X=o.lat(),t.Y=o.lng()}else alert("Ошибка получения координат")}).error(function(){alert("Не удалось соединиться с сервером")})})},displayPoint:function(e){var r=n(e.coordinateX,e.coordinateY,t.DISPLAY_ZOOM);if(e&&r){var o="Точка: "+e.name+"<br> Адрес: "+e.address,l={lat:parseFloat(e.coordinateX),lng:parseFloat(e.coordinateY)};r.map.openInfoWindow(l,o)}else alert("Нечего показывать")}}}]);
AzoftTest.factory("Storage",function(){var e={STORAGE_NAME:"pointStorage",MAX_LENGTH:20},t=[],n=function(){try{localStorage.setItem(e.STORAGE_NAME,angular.toJson(t))}catch(n){alert("Ошибка добавления в локальное хранилище: "+n)}};return{setMaxLength:function(t){e.MAX_LENGTH=t||e.MAX_LENGTH},getMaxLength:function(){return e.MAX_LENGTH},setStorageName:function(t){e.STORAGE_NAME=t||e.STORAGE_NAME},addToStorage:function(e){var r=!0;return"number"==typeof e.X&&"number"==typeof e.Y&&e.name.length&&e.address.length?(t||(t=[]),t.push({name:e.name,address:e.address,coordinateX:e.X,coordinateY:e.Y}),n()):(alert("Ошибка типа данных"),r=!1),r},responseStorage:function(){try{t=JSON.parse(localStorage.getItem(e.STORAGE_NAME)),t||(t=[])}catch(n){alert("Ошибка обращения к LocalStorage: "+n),t=[]}return t}}});

;AzoftTest.controller("CreateController",["Storage","GMap",function(e,t){t.addPoint(this),this.maxLength=e.getMaxLength(),this.createPoint=function(t){e.addToStorage(t)&&(this.name="",this.create=!0)}}]);
AzoftTest.controller("ListController",["Storage",function(e){this.content=e.responseStorage()}]);
AzoftTest.controller("MapController",["$scope","$routeParams","GMap",function(e,t,n){e.$on("$routeChangeSuccess",function(){e.data=JSON.parse(t.data),n.displayPoint(e.data)})}]);
AzoftTest.controller("SearchController",["Storage",function(e){var t=this;t.maxLength=e.getMaxLength(),t.point=e.responseStorage(),t.selectedPoint=function(e){e?t.data=e.originalObject:t.data=null}}]);
